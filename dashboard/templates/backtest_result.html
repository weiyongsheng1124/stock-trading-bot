<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨äº¤æ˜“æ©Ÿå™¨äºº - å›æ¸¬çµæœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- å°èˆªæ¬„ -->
    <nav class="bg-gray-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="text-xl font-bold">ğŸ“ˆ è‚¡ç¥¨äº¤æ˜“æ©Ÿå™¨äºº</div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/monitor" class="px-4 py-2 hover:text-gray-300">å³æ™‚ç›£æ§</a>
                    <a href="/backtest" class="bg-blue-600 px-4 py-2 rounded">å›æ¸¬</a>
                    <a href="/config" class="px-4 py-2 hover:text-gray-300">åƒæ•¸é…ç½®</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- è¿”å›é€£çµ -->
        <div class="mb-4">
            <a href="/backtest" class="text-blue-600 hover:underline">â† é‡æ–°å›æ¸¬</a>
        </div>

        {% if error %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            âŒ {{ error }}
        </div>
        {% else %}

        <!-- æ¨™é¡Œ -->
        <h1 class="text-3xl font-bold mb-2">{{ symbol }} å›æ¸¬çµæœ</h1>
        <p class="text-gray-600 mb-8">
            æœŸé–“ï¼š{{ period }} / {{ interval }} / åˆå§‹è³‡é‡‘ï¼š${{ "{:,}".format(capital) }}
        </p>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-xs">ç¸½å ±é…¬ç‡</div>
                <div class="text-2xl font-bold {% if result.total_return|default(0) >= 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    {{ "%.2f"|format(result.total_return|default(0)) }}%
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-xs">äº¤æ˜“æ¬¡æ•¸</div>
                <div class="text-2xl font-bold text-blue-600">{{ result.total_trades|default(0) }}</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-xs">å‹ç‡</div>
                <div class="text-2xl font-bold {% if result.win_rate|default(0) >= 50 %}text-red-600{% else %}text-green-600{% endif %}">
                    {{ "%.1f"|format(result.win_rate|default(0)) }}%
                </div>
                <div class="text-xs text-gray-400">{{ result.wins|default(0) }} å‹ / {{ result.losses|default(0) }} æ•—</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-xs">æœ€å¤§å›æ’¤</div>
                <div class="text-2xl font-bold text-red-600">{{ "%.2f"|format(result.max_drawdown|default(0)) }}%</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-xs">æœ€çµ‚è³‡é‡‘</div>
                <div class="text-2xl font-bold {% if result.final_capital|default(capital) > capital %}text-red-600{% else %}text-green-600{% endif %}">
                    ${{ "{:,.0f}".format(result.final_capital|default(capital)) }}
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-xs">ç²åˆ©é‡‘é¡</div>
                <div class="text-2xl font-bold {% if (result.final_capital|default(capital) - capital) >= 0 %}text-red-600{% else %}text-green-600{% endif %}">
                    ${{ "{:+,.0f}".format((result.final_capital|default(capital) - capital)) }}
                </div>
            </div>
        </div>

        <!-- åƒæ•¸å„ªåŒ–å™¨ -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <div class="bg-purple-600 text-white px-6 py-4 flex justify-between items-center">
                <h2 class="text-lg font-bold">ğŸ¯ åƒæ•¸å„ªåŒ–å™¨</h2>
                <span class="text-sm opacity-80">æ ¹æ“šç›®æ¨™å‹ç‡æ¨è–¦æœ€ä½³åƒæ•¸</span>
            </div>
            <div class="p-6">
                <div class="flex flex-wrap gap-4 items-end mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">ç›®æ¨™å‹ç‡ (%)</label>
                        <input type="number" id="targetWinRate" value="60" min="0" max="100" 
                               class="w-32 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button onclick="optimizeParams()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded shadow">
                        ğŸ” å°‹æ‰¾æœ€ä½³åƒæ•¸
                    </button>
                </div>
                
                <!-- å„ªåŒ–çµæœ -->
                <div id="optimizeResult" class="hidden">
                    <div class="border-t pt-4">
                        <h3 class="font-bold text-lg mb-4">âœ¨ æ¨è–¦åƒæ•¸</h3>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">MACD Fast</div>
                                <div id="rec-macd-fast" class="text-xl font-bold text-blue-600">-</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">MACD Slow</div>
                                <div id="rec-macd-slow" class="text-xl font-bold text-blue-600">-</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">MACD Signal</div>
                                <div id="rec-macd-signal" class="text-xl font-bold text-blue-600">-</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">RSI é€±æœŸ</div>
                                <div id="rec-rsi-period" class="text-xl font-bold text-purple-600">-</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">ç¢ºèªæ£’æ•¸</div>
                                <div id="rec-confirm" class="text-xl font-bold text-green-600">-</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="text-gray-500 text-xs">åœæå€æ•¸</div>
                                <div id="rec-stop" class="text-xl font-bold text-red-600">-</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <div class="text-green-600 text-xs">é ä¼°å‹ç‡</div>
                                <div id="rec-winrate" class="text-xl font-bold text-green-600">-</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <div class="text-green-600 text-xs">é ä¼°å ±é…¬</div>
                                <div id="rec-return" class="text-xl font-bold text-green-600">-</div>
                            </div>
                        </div>
                        
                        <button onclick="showApplyModal()" 
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded shadow">
                            âœ… å¥—ç”¨é€™äº›åƒæ•¸
                        </button>
                    </div>
                </div>
                
                <div id="optimizeLoading" class="hidden text-center py-4">
                    <span class="text-purple-600 font-bold">ğŸ”„ æœå°‹æœ€ä½³åƒæ•¸ä¸­...</span>
                </div>
            </div>
        </div>

        <!-- åœ–è¡¨å€åŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="font-bold text-lg mb-4">ğŸ’° è³‡é‡‘æ›²ç·š</h3>
                <canvas id="equityChart"></canvas>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="font-bold text-lg mb-4">ğŸ“‰ å›æ’¤æ›²ç·š</h3>
                <canvas id="drawdownChart"></canvas>
            </div>
        </div>

        <!-- è‚¡åƒ¹èµ°å‹¢åœ– -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h3 class="font-bold text-lg mb-4">ğŸ“ˆ è‚¡åƒ¹èµ°å‹¢èˆ‡è²·è³£é»</h3>
            <canvas id="priceChart"></canvas>
            <div class="mt-4 flex gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 bg-red-500 rounded-full"></span>
                    <span>è²·å…¥é»</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-4 h-4 bg-green-500 rounded-full"></span>
                    <span>è³£å‡ºé»</span>
                </div>
            </div>
        </div>

        <!-- MACD åœ–è¡¨ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h3 class="font-bold text-lg mb-4">ğŸ“Š MACD</h3>
            <canvas id="macdChart"></canvas>
        </div>

        <!-- RSI åœ–è¡¨ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h3 class="font-bold text-lg mb-4">ğŸ“Š RSI</h3>
            <canvas id="rsiChart"></canvas>
        </div>

        <!-- ADX åœ–è¡¨ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h3 class="font-bold text-lg mb-4">ğŸ“Š ADX</h3>
            <canvas id="adxChart"></canvas>
        </div>

        <!-- ç­–ç•¥åƒæ•¸ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h3 class="font-bold text-lg mb-4">âš™ï¸ ç›®å‰ä½¿ç”¨çš„ç­–ç•¥åƒæ•¸</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>MACD: {{ result.params.macd.fast if result and result.params and result.params.macd else '-' }}, {{ result.params.macd.slow if result and result.params and result.params.macd else '-' }}, {{ result.params.macd.signal if result and result.params and result.params.macd else '-' }}</div>
                <div>RSI: {{ result.params.rsi.period if result and result.params and result.params.rsi else '-' }} ({{ result.params.rsi.oversold if result and result.params and result.params.rsi else '-' }}/{{ result.params.rsi.overbought if result and result.params and result.params.rsi else '-' }})</div>
                <div>ADX: {{ result.params.adx.period if result and result.params and result.params.adx else '-' }} (> {{ result.params.adx.threshold if result and result.params and result.params.adx else '-' }})</div>
                <div>ATR: {{ result.params.atr.period if result and result.params and result.params.atr else '-' }}</div>
                <div>ç¢ºèªæ£’æ•¸: {{ result.params.confirm_bars if result and result.params else '-' }}</div>
                <div>åœæå€æ•¸: {{ result.params.stop_loss_multiplier if result and result.params else '-' }}</div>
            </div>
        </div>

        <!-- äº¤æ˜“æ˜ç´° -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-gray-800 text-white px-6 py-4">
                <h2 class="text-lg font-bold">ğŸ“œ äº¤æ˜“æ˜ç´°</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">è²·å…¥æ—¥æœŸ</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">è²·å…¥</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">è³£å‡º</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">æç›Š</th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">çµæœ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for trade in result.trades %}
                        <tr class="{% if trade.win %}bg-red-50{% else %}bg-green-50{% endif %}">
                            <td class="px-4 py-3 text-sm">{{ trade.id }}</td>
                            <td class="px-4 py-3 text-sm">{{ trade.entry_date }}</td>
                            <td class="px-4 py-3 text-sm text-right">${{ trade.entry_price }}</td>
                            <td class="px-4 py-3 text-sm text-right">${{ trade.exit_price }}</td>
                            <td class="px-4 py-3 text-sm text-right font-bold {% if trade.pnl >= 0 %}text-red-600{% else %}text-green-600{% endif %}">
                                {{ "%.2f"|format(trade.pnl) }}%
                            </td>
                            <td class="px-4 py-3 text-center">
                                {% if trade.win %}
                                <span class="px-2 py-1 bg-red-200 text-red-800 rounded text-xs">ç²åˆ©</span>
                                {% else %}
                                <span class="px-2 py-1 bg-green-200 text-green-800 rounded text-xs">è™§æ</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% endif %}

        <!-- è¿”å›é€£çµ -->
        <div class="mt-8 text-center">
            <a href="/backtest" class="text-blue-600 hover:underline">â† é‡æ–°å›æ¸¬</a>
        </div>
    </div>

    <script>
        const symbol = '{{ symbol }}';
        const period = '{{ period }}';
        const interval = '{{ interval }}';
        const capital = {{ capital }};

        {% if result and result.equity_curve %}
        // æ•¸æ“š
        const equityData = {{ result.equity_curve | tojson | safe }};
        const drawdownData = {{ result.drawdown | tojson | safe }};
        const priceData = {{ result.price_data | tojson | safe }};
        const macdData = {{ result.macd_data | tojson | safe }};
        const rsiData = {{ result.rsi_data | tojson | safe }};
        const adxData = {{ result.adx_data | tojson | safe }};
        const buySignals = {{ result.buy_signals | tojson | safe }};
        const sellSignals = {{ result.sell_signals | tojson | safe }};

        // çµ±ä¸€æ—¥æœŸæ¨™ç±¤ï¼ˆä½¿ç”¨ equityData çš„æ™‚é–“ï¼‰
        const allLabels = equityData.map(d => d.time);
        
        // å»ºç«‹æ™‚é–“åˆ°åƒ¹æ ¼/ä¿¡è™Ÿçš„æ˜ å°„
        const priceMap = {};
        priceData.forEach(p => priceMap[p.time] = p.close);
        
        const buySet = new Set(buySignals.map(b => b.time));
        const sellSet = new Set(sellSignals.map(s => s.time));

        // è³‡é‡‘æ›²ç·š
        new Chart(document.getElementById('equityChart'), {
            type: 'line',
            data: {
                labels: allLabels,
                datasets: [{
                    label: 'è³‡é‡‘è®ŠåŒ–%',
                    data: equityData.map(d => d.equity_pct),
                    borderColor: '#2563eb',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { y: { position: 'right', title: { display: true, text: 'è®ŠåŒ– %' } } }
            }
        });

        // å›æ’¤æ›²ç·š
        new Chart(document.getElementById('drawdownChart'), {
            type: 'line',
            data: {
                labels: allLabels,
                datasets: [{
                    label: 'å›æ’¤',
                    data: drawdownData.map(d => d.drawdown),
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { position: 'right', title: { display: true, text: 'å›æ’¤ %' }, beginAtZero: true },
                    x: { ticks: { maxTicksLimit: 20 } }
                }
            }
        });

        // è‚¡åƒ¹èµ°å‹¢åœ–ï¼ˆè²·è³£é»æ¨™è¨˜ï¼‰
        // buySignals å’Œ sellSignals çš„ index æ˜¯åŸå§‹ dataframe çš„ç´¢å¼•
        // priceData ä¹Ÿæ˜¯å¾åŸå§‹ dataframe çš„ç´¢å¼• 0 é–‹å§‹
        // æ‰€ä»¥ç›´æ¥ä½¿ç”¨ b.index ä½œç‚º x åº§æ¨™
        
        const buyPoints = buySignals.map(b => ({
            x: b.index,  // ç›´æ¥ä½¿ç”¨å¾Œç«¯çš„ index
            y: priceMap[b.time] || b.price
        })).filter(p => p.x >= 0 && p.x < priceData.length);
        
        const sellPoints = sellSignals.map(s => ({
            x: s.index,  // ç›´æ¥ä½¿ç”¨å¾Œç«¯çš„ index
            y: priceMap[s.time] || s.price
        })).filter(p => p.x >= 0 && p.x < priceData.length);

        new Chart(document.getElementById('priceChart'), {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'è‚¡åƒ¹',
                        data: priceData.map((p, i) => ({x: i, y: p.close})),
                        borderColor: '#374151',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.1,
                        order: 2
                    },
                    {
                        label: 'è²·å…¥',
                        data: buyPoints,
                        borderColor: '#ef4444',
                        backgroundColor: '#ef4444',
                        pointStyle: 'triangle',
                        pointRadius: 10,
                        pointRotation: 0,
                        showLine: false,
                        order: 1
                    },
                    {
                        label: 'è³£å‡º',
                        data: sellPoints,
                        borderColor: '#22c55e',
                        backgroundColor: '#22c55e',
                        pointStyle: 'triangle',
                        pointRadius: 10,
                        pointRotation: 180,
                        showLine: false,
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return '';  // éš±è—æ¨™é¡Œ
                            },
                            label: function(context) {
                                const idx = context.parsed.x;
                                const time = priceData[idx]?.time || '';
                                if (context.dataset.label === 'è²·å…¥') {
                                    return 'è²·å…¥ $' + context.parsed.y.toFixed(2) + ' (' + time + ')';
                                } else if (context.dataset.label === 'è³£å‡º') {
                                    return 'è³£å‡º $' + context.parsed.y.toFixed(2) + ' (' + time + ')';
                                }
                                return '$' + context.parsed.y.toFixed(2) + ' (' + time + ')';
                            }
                        }
                    }
                },
                scales: { 
                    y: { position: 'right', title: { display: true, text: 'è‚¡åƒ¹' } },
                    x: { 
                        type: 'linear',
                        min: 0,
                        max: priceData.length - 1,
                        ticks: { 
                            maxTicksLimit: 20,
                            callback: function(value) {
                                const idx = Math.round(value);
                                return priceData[idx]?.time || '';
                            },
                            autoSkip: true,
                            maxRotation: 0
                        },
                        grid: { display: false }
                    }
                }
            }
        });

        // MACD åœ–è¡¨
        if (macdData && macdData.length > 0) {
            new Chart(document.getElementById('macdChart'), {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [
                        {
                            label: 'MACD',
                            data: macdData.map(d => d.macd),
                            borderColor: '#3b82f6',
                            backgroundColor: 'transparent',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Signal',
                            data: macdData.map(d => d.signal),
                            borderColor: '#f59e0b',
                            backgroundColor: 'transparent',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            tension: 0.1
                        },
                        {
                            label: 'Hist',
                            data: macdData.map(d => d.hist),
                            borderColor: 'transparent',
                            backgroundColor: macdData.map(d => d.hist >= 0 ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)'),
                            borderWidth: 0,
                            pointRadius: 0,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { y: { title: { display: true, text: 'MACD' } } }
                }
            });
        }

        // RSI åœ–è¡¨
        if (rsiData && rsiData.length > 0) {
            new Chart(document.getElementById('rsiChart'), {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [{
                        label: 'RSI',
                        data: rsiData.map(d => d.rsi),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { 
                        y: { min: 0, max: 100, title: { display: true, text: 'RSI' } },
                        x: { ticks: { maxTicksLimit: 20 } }
                    }
                }
            });
        }

        // ADX åœ–è¡¨
        if (adxData && adxData.length > 0) {
            new Chart(document.getElementById('adxChart'), {
                type: 'line',
                data: {
                    labels: allLabels,
                    datasets: [{
                        label: 'ADX',
                        data: adxData.map(d => d.adx),
                        borderColor: '#10b981',
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { 
                        y: { title: { display: true, text: 'ADX' } },
                        x: { ticks: { maxTicksLimit: 20 } }
                    }
                }
            });
        }
        {% endif %}

        // ============ åƒæ•¸å„ªåŒ–å™¨ ============
        function optimizeParams() {
            const targetWinRate = document.getElementById('targetWinRate').value;
            const btn = document.querySelector('button[onclick="optimizeParams()"]');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'ğŸ”„ æœå°‹ä¸­...';
            
            document.getElementById('optimizeResult').classList.add('hidden');
            document.getElementById('optimizeLoading').classList.remove('hidden');
            
            fetch('/api/optimize', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    symbol: symbol,
                    target_win_rate: parseFloat(targetWinRate),
                    period: period,
                    interval: interval,
                    initial_capital: capital
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ä¼ºæœå™¨éŒ¯èª¤: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                btn.disabled = false;
                btn.innerText = originalText;
                document.getElementById('optimizeLoading').classList.add('hidden');
                
                if (data.success && data.recommended_params) {
                    const params = data.recommended_params;
                    const result = data.result;
                    
                    document.getElementById('rec-macd-fast').innerText = params.macd.fast;
                    document.getElementById('rec-macd-slow').innerText = params.macd.slow;
                    document.getElementById('rec-macd-signal').innerText = params.macd.signal;
                    document.getElementById('rec-rsi-period').innerText = params.rsi.period;
                    document.getElementById('rec-confirm').innerText = params.confirm_bars;
                    document.getElementById('rec-stop').innerText = params.stop_loss_multiplier;
                    document.getElementById('rec-winrate').innerText = (result.win_rate || 0) + '%';
                    document.getElementById('rec-return').innerText = (result.total_return || 0) + '%';
                    
                    // å„²å­˜æ¨è–¦åƒæ•¸
                    window.recommendedParams = params;
                    
                    document.getElementById('optimizeResult').classList.remove('hidden');
                } else {
                    const errorMsg = data.error || 'æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„åƒæ•¸çµ„åˆ';
                    alert('âŒ ' + errorMsg);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerText = originalText;
                document.getElementById('optimizeLoading').classList.add('hidden');
                alert('âŒ ç¶²è·¯éŒ¯èª¤ï¼š' + err.message + '\nè«‹ç¨å¾Œå†è©¦');
            });
        }

        function showApplyModal() {
            if (!window.recommendedParams) {
                alert('è«‹å…ˆåŸ·è¡Œåƒæ•¸å„ªåŒ–');
                return;
            }
            document.getElementById('applyModal').classList.remove('hidden');
        }

        function closeApplyModal() {
            document.getElementById('applyModal').classList.add('hidden');
        }

        function applyToSymbol() {
            const targetSymbol = document.getElementById('targetSymbol').value;
            if (!targetSymbol) {
                alert('è«‹é¸æ“‡è‚¡ç¥¨');
                return;
            }
            
            const p = window.recommendedParams;
            const params = {
                macd: { fast: p.macd.fast, slow: p.macd.slow, signal: p.macd.signal },
                rsi: { period: p.rsi.period, oversold: 30, overbought: 70 },
                adx: { period: p.adx.period, threshold: p.adx.threshold },
                atr: { period: 14 },
                confirm_bars: p.confirm_bars,
                stop_loss_multiplier: p.stop_loss_multiplier
            };
            
            // ç·¨ç¢¼åƒæ•¸ç‚º URL
            const paramsJson = encodeURIComponent(JSON.stringify(params));
            
            // é‡æ–°å›æ¸¬ï¼Œä½¿ç”¨æ–°åƒæ•¸
            const url = '/backtest/result?symbol=' + targetSymbol + 
                       '&period=' + period + 
                       '&interval=' + interval + 
                       '&capital=' + capital +
                       '&params_data=' + paramsJson;
            window.location.href = url;
        }
    </script>

    <!-- é¸æ“‡è‚¡ç¥¨ Modal -->
    <div id="applyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
            <h3 class="text-xl font-bold mb-4">é¸æ“‡è¦å¥—ç”¨åƒæ•¸çš„è‚¡ç¥¨</h3>
            <select id="targetSymbol" class="w-full px-4 py-2 border rounded mb-4">
                <option value="">-- è«‹é¸æ“‡è‚¡ç¥¨ --</option>
                {% for s in symbols %}
                <option value="{{ s }}" {% if s == symbol %}selected{% endif %}>{{ s }}</option>
                {% endfor %}
            </select>
            <div class="flex justify-end gap-2">
                <button onclick="closeApplyModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                <button onclick="applyToSymbol()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">å¥—ç”¨</button>
            </div>
        </div>
    </div>
</body>
</html>
