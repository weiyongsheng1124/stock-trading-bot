<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨äº¤æ˜“æ©Ÿå™¨äºº - å³æ™‚ç›£æ§</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .status-buy { background-color: #dcfce7; color: #166534; }
        .status-holding { background-color: #fef08a; color: #854d0e; }
        .status-sell { background-color: #fee2e2; color: #991b1b; }
        .status-cooldown { background-color: #f3f4f6; color: #6b7280; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- å°èˆªæ¬„ -->
    <nav class="bg-gray-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="text-xl font-bold">ğŸ“ˆ è‚¡ç¥¨äº¤æ˜“æ©Ÿå™¨äºº</div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/monitor" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">å³æ™‚ç›£æ§</a>
                    <a href="/config" class="px-4 py-2 hover:text-gray-300">ç­–ç•¥é…ç½®</a>
                    <a href="/backtest" class="px-4 py-2 hover:text-gray-300">å›æ¸¬</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- ç‹€æ…‹ç¸½è¦½ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">äº¤æ˜“æ™‚æ®µ</div>
                <div class="text-2xl font-bold text-green-600">
                    {{ trading_hours.start }} - {{ trading_hours.end }}
                </div>
                <div class="text-sm text-gray-400">å°ç£æ™‚é–“</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">ç›£æ§è‚¡ç¥¨</div>
                <div class="text-2xl font-bold text-blue-600">{{ symbols|length }}</div>
                <div class="text-sm text-gray-400">æª”</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">æŒå€‰æ•¸é‡</div>
                <div class="text-2xl font-bold text-yellow-600">{{ positions|length }}</div>
                <div class="text-sm text-gray-400">æª”</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">å‹ç‡</div>
                <div class="text-2xl font-bold text-purple-600">{{ "%.1f"|format(stats.win_rate|default(0)) }}%</div>
                <div class="text-sm text-gray-400">{{ stats.total_trades|default(0) }} ç­†äº¤æ˜“</div>
            </div>
        </div>

        <!-- ç›£æ§è‚¡ç¥¨ç®¡ç† -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <div class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
                <h2 class="text-lg font-bold">ğŸ“ˆ ç›£æ§è‚¡ç¥¨æ¸…å–®</h2>
                <button onclick="openSymbolModal()" class="bg-white text-blue-600 px-4 py-2 rounded text-sm font-bold hover:bg-gray-100">
                    + æ–°å¢è‚¡ç¥¨
                </button>
            </div>
            <div class="p-6">
                <div id="symbols-list" class="flex flex-wrap gap-2">
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- æŒå€‰å€åŸŸ -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-gray-800 text-white px-6 py-4">
                    <h2 class="text-lg font-bold">ğŸ“Š ç›®å‰æŒå€‰</h2>
                </div>
                <div class="p-6">
                    {% if positions %}
                    <div class="space-y-4">
                        {% for pos in positions %}
                        <div class="border rounded-lg p-4 {% if pos.status == 'HOLDING' %}status-holding{% elif pos.status == 'SIGNAL_BUY_SENT' %}status-buy{% elif pos.status == 'SIGNAL_SELL_SENT' %}status-sell{% endif %}">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-lg">{{ pos.symbol }}</span>
                                <span class="px-2 py-1 rounded text-xs font-bold">
                                    {% if pos.status == 'SIGNAL_BUY_SENT' %}
                                    ğŸŸ¢ å¾…è²·å…¥
                                    {% elif pos.status == 'HOLDING' %}
                                    ğŸŸ¡ æŒæœ‰ä¸­
                                    {% elif pos.status == 'SIGNAL_SELL_SENT' %}
                                    ğŸ”´ å¾…è³£å‡º
                                    {% endif %}
                                </span>
                            </div>
                            {% if pos.holding_info %}
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>è²·å…¥åƒ¹ï¼š<span class="font-bold">{{ pos.holding_info.entry_price }}</span></div>
                                <div>åœæï¼š<span class="font-bold text-red-600">{{ pos.holding_info.stop_loss }}</span></div>
                                <div>è²·å…¥æ™‚é–“ï¼š<span class="text-gray-600">{{ pos.holding_info.entry_time }}</span></div>
                                <div>æ•¸é‡ï¼š<span class="text-gray-600">{{ pos.holding_info.quantity or 'æœªè¼¸å…¥' }}</span></div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“­</div>
                        <div>ç›®å‰æ²’æœ‰æŒå€‰</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- å†·å»å€åŸŸ -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-gray-800 text-white px-6 py-4">
                    <h2 class="text-lg font-bold">â³ å†·å»ä¸­</h2>
                </div>
                <div class="p-6">
                    {% if cooldown %}
                    <div class="space-y-2">
                        {% for c in cooldown %}
                        <div class="flex justify-between items-center p-3 bg-gray-100 rounded">
                            <span>{{ c.symbol }}</span>
                            <span class="text-sm text-gray-500">å†·å»ä¸­</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">âœ…</div>
                        <div>æ²’æœ‰è‚¡ç¥¨åœ¨å†·å»ä¸­</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- äº¤æ˜“ç´€éŒ„ -->
        <div class="mt-8 bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-gray-800 text-white px-6 py-4">
                <h2 class="text-lg font-bold">ğŸ“œ äº¤æ˜“ç´€éŒ„</h2>
            </div>
            <div class="p-6">
                <div id="trades-table" class="overflow-x-auto">
                    <div class="text-center text-gray-500 py-4">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç³»çµ±æ—¥èªŒ -->
        <div class="mt-8 bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-gray-800 text-white px-6 py-4">
                <h2 class="text-lg font-bold">ğŸ“‹ ç³»çµ±æ—¥èªŒ</h2>
            </div>
            <div class="p-6">
                <div id="logs-container" class="font-mono text-xs bg-gray-900 text-green-400 p-4 rounded h-48 overflow-y-auto">
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </div>
    </div>

    <script>
        // è‡ªå‹•åˆ·æ–°
        function refreshData() {
            // åˆ·æ–°æŒå€‰
            fetch('/api/positions')
                .then(r => r.json())
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('trades-table').innerHTML = '<div class="text-center text-gray-500 py-4">æ²’æœ‰æŒå€‰</div>';
                    }
                });
            
            // åˆ·æ–°æ—¥èªŒ
            fetch('/api/logs?limit=20')
                .then(r => r.json())
                .then(logs => {
                    const container = document.getElementById('logs-container');
                    container.innerHTML = logs.map(log => 
                        `<div>[${new Date(log.timestamp).toLocaleTimeString()}] ${log.level} - ${log.message}</div>`
                    ).join('');
                });
        }

        // é é¢è¼‰å…¥æ™‚åˆ·æ–°
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            loadSymbols();
            
            // æ¯30ç§’è‡ªå‹•åˆ·æ–°
            setInterval(refreshData, 30000);
        });

        // ============ ç›£æ§è‚¡ç¥¨ç®¡ç† ============
        function loadSymbols() {
            fetch('/api/symbols')
                .then(r => r.json())
                .then(symbols => {
                    const container = document.getElementById('symbols-list');
                    container.innerHTML = symbols.map(s => 
                        `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center gap-2">
                            ${s}
                            <button onclick="removeSymbol('${s}')" class="text-blue-600 hover:text-red-600 font-bold">&times;</button>
                        </span>`
                    ).join('');
                });
        }

        function openSymbolModal() {
            document.getElementById('symbolModal').classList.remove('hidden');
        }

        function closeSymbolModal() {
            document.getElementById('symbolModal').classList.add('hidden');
        }

        function addSymbol() {
            const symbol = document.getElementById('newSymbol').value.trim();
            if (!symbol) return;
            
            fetch('/api/symbols/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbol: symbol})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('newSymbol').value = '';
                    closeSymbolModal();
                    loadSymbols();
                } else {
                    alert('æ–°å¢å¤±æ•—ï¼š' + (data.error || 'è‚¡ç¥¨ä»£ç¢¼å·²å­˜åœ¨'));
                }
            });
        }

        function removeSymbol(symbol) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤ ' + symbol + 'ï¼Ÿ')) return;
            
            fetch('/api/symbols/remove', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbol: symbol})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    loadSymbols();
                }
            });
        }
    </script>

    <!-- æ–°å¢è‚¡ç¥¨ Modal -->
    <div id="symbolModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
            <h3 class="text-xl font-bold mb-4">æ–°å¢ç›£æ§è‚¡ç¥¨</h3>
            <input type="text" id="newSymbol" placeholder="ä¾‹å¦‚ï¼š2330.TW" 
                   class="w-full px-4 py-2 border rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-end gap-2">
                <button onclick="closeSymbolModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                <button onclick="addSymbol()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">æ–°å¢</button>
            </div>
        </div>
    </div>
</body>
</html>
