<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨äº¤æ˜“æ©Ÿå™¨äºº - å³æ™‚ç›£æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-buy { background-color: #dcfce7; color: #166534; }
        .status-holding { background-color: #fef08a; color: #854d0e; }
        .status-sell { background-color: #fee2e2; color: #991b1b; }
        .status-cooldown { background-color: #f3f4f6; color: #6b7280; }
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
        @media (max-width: 640px) {
            .chart-container {
                height: 150px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- å°èˆªæ¬„ -->
    <nav class="bg-gray-800 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="text-xl font-bold">ğŸ“ˆ è‚¡ç¥¨äº¤æ˜“æ©Ÿå™¨äºº</div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/monitor" class="bg-blue-600 px-4 py-2 rounded">å³æ™‚ç›£æ§</a>
                    <a href="/backtest" class="px-4 py-2 hover:text-gray-300">å›æ¸¬</a>
                    <a href="/config" class="px-4 py-2 hover:text-gray-300">åƒæ•¸é…ç½®</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- ç‹€æ…‹ç¸½è¦½ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">äº¤æ˜“æ™‚æ®µ</div>
                <div class="text-2xl font-bold text-green-600">
                    {{ trading_hours.start }} - {{ trading_hours.end }}
                </div>
                <div class="text-sm text-gray-400">å°ç£æ™‚é–“</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">ç›£æ§è‚¡ç¥¨</div>
                <div class="text-2xl font-bold text-blue-600">{{ symbols|length }}</div>
                <div class="text-sm text-gray-400">æª”</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">æŒå€‰æ•¸é‡</div>
                <div class="text-2xl font-bold text-yellow-600">{{ positions|length }}</div>
                <div class="text-sm text-gray-400">æª”</div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm">å‹ç‡</div>
                <div class="text-2xl font-bold text-purple-600">{{ "%.1f"|format(stats.win_rate|default(0)) }}%</div>
                <div class="text-sm text-gray-400">{{ stats.total_trades|default(0) }} ç­†äº¤æ˜“</div>
            </div>
        </div>

        <!-- ç›£æ§è‚¡ç¥¨ç®¡ç† -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <div class="bg-blue-600 text-white px-6 py-4 flex justify-between items-center">
                <h2 class="text-lg font-bold">ğŸ“ˆ ç›£æ§è‚¡ç¥¨æ¸…å–®</h2>
                <button onclick="openSymbolModal()" class="bg-white text-blue-600 px-4 py-2 rounded text-sm font-bold hover:bg-gray-100">
                    + æ–°å¢è‚¡ç¥¨
                </button>
            </div>
            <div class="p-6">
                <div id="symbols-list" class="flex flex-wrap gap-2">
                    {% for s in symbols %}
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center gap-2">
                        {{ s }}
                        <button onclick="removeSymbol('{{ s }}')" class="text-blue-600 hover:text-red-600 font-bold">&times;</button>
                    </span>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- å³æ™‚åœ–è¡¨å€åŸŸ -->
        {% for symbol in symbols %}
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <div class="bg-gray-800 text-white px-6 py-4 flex justify-between items-center">
                <h2 class="text-lg font-bold">ğŸ“Š {{ symbol }} å³æ™‚ç›£æ§</h2>
                <span id="status-{{ symbol }}" class="text-sm px-3 py-1 rounded bg-gray-600">è¼‰å…¥ä¸­...</span>
                    <a href="/config/{{ symbol }}" class="text-xs text-blue-300 hover:text-white ml-2">âš™ï¸ è¨­å®š</a>
            </div>
            <div class="p-6">
                <!-- Kç·šåœ– -->
                <div class="mb-6">
                    <h3 class="font-bold text-gray-700 mb-2">5åˆ†é˜Kç·š</h3>
                    <div class="chart-container">
                        <canvas id="chart-{{ symbol }}"></canvas>
                    </div>
                </div>
                
                <!-- MACD -->
                <div class="mb-6">
                    <h3 class="font-bold text-gray-700 mb-2">MACD</h3>
                    <div class="chart-container">
                        <canvas id="macd-{{ symbol }}"></canvas>
                    </div>
                </div>
                
                <!-- RSI & ADX -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2">RSI</h3>
                        <div class="chart-container">
                            <canvas id="rsi-{{ symbol }}"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-700 mb-2">ADX</h3>
                        <div class="chart-container">
                            <canvas id="adx-{{ symbol }}"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- æŒå€‰è³‡è¨Š -->
                <div id="holding-{{ symbol }}" class="mt-4 p-4 bg-gray-50 rounded-lg hidden">
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>è²·å…¥åƒ¹ï¼š<span id="entry-{{ symbol }}" class="font-bold"></span></div>
                        <div>åœæåƒ¹ï¼š<span id="stop-{{ symbol }}" class="font-bold text-red-600"></span></div>
                        <div>ç‹€æ…‹ï¼š<span id="position-status-{{ symbol }}" class="font-bold"></span></div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- æŒå€‰å€åŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-gray-800 text-white px-6 py-4">
                    <h2 class="text-lg font-bold">ğŸ“Š ç›®å‰æŒå€‰</h2>
                </div>
                <div class="p-6">
                    {% if positions %}
                    <div class="space-y-4">
                        {% for pos in positions %}
                        <div class="border rounded-lg p-4 {% if pos.status == 'HOLDING' %}status-holding{% elif pos.status == 'SIGNAL_BUY_SENT' %}status-buy{% elif pos.status == 'SIGNAL_SELL_SENT' %}status-sell{% endif %}">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-lg">{{ pos.symbol }}</span>
                                <span class="px-2 py-1 rounded text-xs font-bold">
                                    {% if pos.status == 'SIGNAL_BUY_SENT' %}ğŸŸ¢ å¾…è²·å…¥
                                    {% elif pos.status == 'HOLDING' %}ğŸŸ¡ æŒæœ‰ä¸­
                                    {% elif pos.status == 'SIGNAL_SELL_SENT' %}ğŸ”´ å¾…è³£å‡º{% endif %}
                                </span>
                            </div>
                            {% if pos.holding_info %}
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div>è²·å…¥åƒ¹ï¼š{{ pos.holding_info.entry_price }}</div>
                                <div>åœæï¼š{{ pos.holding_info.stop_loss }}</div>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">ğŸ“­</div>
                        <div>ç›®å‰æ²’æœ‰æŒå€‰</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- å†·å»å€åŸŸ -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="bg-gray-800 text-white px-6 py-4">
                    <h2 class="text-lg font-bold">â³ å†·å»ä¸­</h2>
                </div>
                <div class="p-6">
                    {% if cooldown %}
                    <div class="space-y-2">
                        {% for c in cooldown %}
                        <div class="flex justify-between items-center p-3 bg-gray-100 rounded">
                            <span>{{ c.symbol }}</span>
                            <span class="text-sm text-gray-500">å†·å»ä¸­</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-2">âœ…</div>
                        <div>æ²’æœ‰è‚¡ç¥¨åœ¨å†·å»ä¸­</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢è‚¡ç¥¨ Modal -->
    <div id="symbolModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
            <h3 class="text-xl font-bold mb-4">æ–°å¢ç›£æ§è‚¡ç¥¨</h3>
            <input type="text" id="newSymbol" placeholder="ä¾‹å¦‚ï¼š2330.TW" 
                   class="w-full px-4 py-2 border rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="flex justify-end gap-2">
                <button onclick="closeSymbolModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                <button id="symbolSubmit" onclick="addSymbol()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">æ–°å¢</button>
            </div>
        </div>
    </div>

    <script>
        // ============ ç›£æ§è‚¡ç¥¨ç®¡ç† ============
        function loadSymbols() {
            fetch('/api/symbols')
                .then(r => r.json())
                .then(symbols => {
                    const container = document.getElementById('symbols-list');
                    container.innerHTML = symbols.map(s => 
                        `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full flex items-center gap-2">
                            ${s}
                            <button onclick="removeSymbol('${s}')" class="text-blue-600 hover:text-red-600 font-bold">&times;</button>
                        </span>`
                    ).join('');
                });
        }

        function openSymbolModal() {
            document.getElementById('symbolModal').classList.remove('hidden');
        }

        function closeSymbolModal() {
            document.getElementById('symbolModal').classList.add('hidden');
            document.getElementById('newSymbol').value = '';
        }

        function addSymbol() {
            const symbol = document.getElementById('newSymbol').value.trim().toUpperCase();
            if (!symbol) return;
            
            document.getElementById('symbolSubmit').disabled = true;
            document.getElementById('symbolSubmit').innerText = 'é©—è­‰ä¸­...';
            
            fetch('/api/symbols/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbol: symbol})
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('symbolSubmit').disabled = false;
                document.getElementById('symbolSubmit').innerText = 'æ–°å¢';
                
                if (data.success) {
                    closeSymbolModal();
                    loadSymbols();
                    location.reload();  // é‡æ–°è¼‰å…¥é é¢é¡¯ç¤ºæ–°åœ–è¡¨
                } else {
                    alert('âŒ ' + data.error);
                }
            })
            .catch(err => {
                document.getElementById('symbolSubmit').disabled = false;
                alert('âŒ é©—è­‰å¤±æ•—');
            });
        }

        function removeSymbol(symbol) {
            if (!confirm('ç¢ºå®šè¦ç§»é™¤ ' + symbol + 'ï¼Ÿ')) return;
            
            fetch('/api/symbols/remove', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbol: symbol})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    loadSymbols();
                }
            });
        }

        // ============ åœ–è¡¨è¼‰å…¥ ============
        {% for symbol in symbols %}
        (function() {
            console.log('è¼‰å…¥ {{ symbol }}...');
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);
            
            fetch('/api/live_chart/{{ symbol }}', { signal: controller.signal })
                .then(r => {
                    clearTimeout(timeoutId);
                    console.log('{{ symbol }} å›æ‡‰ç‹€æ…‹:', r.status);
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    clearTimeout(timeoutId);
                    console.log('{{ symbol }} è³‡æ–™:', data);
                    
                    if (data.error) {
                        document.getElementById('status-{{ symbol }}').innerText = 'âŒ ' + (data.error || 'è¼‰å…¥å¤±æ•—');
                        document.getElementById('status-{{ symbol }}').className = 'text-sm px-3 py-1 rounded bg-red-600 text-white';
                        return;
                    }
                    
                    // æ›´æ–°ç‹€æ…‹
                    const statusEl = document.getElementById('status-{{ symbol }}');
                    if (data.position_status === 'HOLDING') {
                        statusEl.innerText = 'ğŸŸ¡ æŒæœ‰ä¸­';
                        statusEl.className = 'text-sm px-3 py-1 rounded bg-yellow-500 text-white';
                    } else if (data.position_status) {
                        statusEl.innerText = 'ğŸ“¡ ' + data.position_status;
                    } else {
                        statusEl.innerText = 'âœ… ç›£æ§ä¸­';
                        statusEl.className = 'text-sm px-3 py-1 rounded bg-green-600 text-white';
                    }
                    
                    // æ›´æ–°æŒå€‰è³‡è¨Š
                    if (data.entry_price || data.stop_loss) {
                        document.getElementById('holding-{{ symbol }}').classList.remove('hidden');
                        if (data.entry_price) document.getElementById('entry-{{ symbol }}').innerText = data.entry_price;
                        if (data.stop_loss) document.getElementById('stop-{{ symbol }}').innerText = data.stop_loss;
                        document.getElementById('position-status-{{ symbol }}').innerText = data.position_status || 'ç„¡';
                    }
                    
                    const candles = data.candles;
                    console.log('{{ symbol }} candles æ•¸é‡:', candles?.length);
                    console.log('{{ symbol }} ç¬¬ä¸€ç­†:', candles?.[0]);
                    
                    if (!candles || candles.length === 0) {
                        document.getElementById('status-{{ symbol }}').innerText = 'âš ï¸ ç„¡Kç·šè³‡æ–™';
                        document.getElementById('status-{{ symbol }}').className = 'text-sm px-3 py-1 rounded bg-yellow-600 text-white';
                        return;
                    }
                    
                    try {
                    const times = candles.map(c => c.time.split(' ')[1]);
                    const opens = candles.map(c => c.open);
                    const highs = candles.map(c => c.high);
                    const lows = candles.map(c => c.low);
                    const closes = candles.map(c => c.close);
                    console.log('{{ symbol }} åƒ¹æ ¼è³‡æ–™è¼‰å…¥å®Œæˆ');
                    
                    // Kç·šåœ–
                    new Chart(document.getElementById('chart-{{ symbol }}'), {
                        type: 'line',
                        data: {
                            labels: times,
                            datasets: [{
                                label: 'åƒ¹æ ¼',
                                data: closes,
                                borderColor: '#2563eb',
                                fill: false,
                                tension: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            elements: { point: { radius: 0 } },
                            scales: { x: { display: false }, y: { position: 'right' } }
                        }
                    });
                    console.log('{{ symbol }} Kç·šåœ–ç¹ªè£½å®Œæˆ');
                    
                    // MACD
                    new Chart(document.getElementById('macd-{{ symbol }}'), {
                        data: {
                            labels: times,
                            datasets: [
                                { type: 'line', label: 'MACD', data: candles.map(c => c.macd), borderColor: '#2563eb', tension: 0.1 },
                                { type: 'line', label: 'Signal', data: candles.map(c => c.macd_signal), borderColor: '#dc2626', tension: 0.1 },
                                { type: 'bar', label: 'Hist', data: candles.map(c => c.macd_hist), backgroundColor: candles.map(c => c.macd_hist >= 0 ? '#22c55e' : '#ef4444'), barThickness: 2 }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            elements: { point: { radius: 0 } },
                            plugins: { legend: { position: 'top' } },
                            scales: { y: { position: 'right' } }
                        }
                    });
                    console.log('{{ symbol }} MACD ç¹ªè£½å®Œæˆ');
                    
                    // RSI
                    new Chart(document.getElementById('rsi-{{ symbol }}'), {
                        type: 'line',
                        data: {
                            labels: times,
                            datasets: [{ label: 'RSI', data: candles.map(c => c.rsi), borderColor: '#7c3aed', borderWidth: 1, fill: false, tension: 0.1 }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            elements: { point: { radius: 0 } },
                            plugins: { legend: { display: false } },
                            scales: { y: { min: 0, max: 100, position: 'right' } }
                        }
                    });
                    console.log('{{ symbol }} RSI ç¹ªè£½å®Œæˆ');
                    
                    // ADX
                    new Chart(document.getElementById('adx-{{ symbol }}'), {
                        type: 'line',
                        data: {
                            labels: times,
                            datasets: [{ label: 'ADX', data: candles.map(c => c.adx), borderColor: '#059669', borderWidth: 1, fill: false, tension: 0.1 }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            elements: { point: { radius: 0 } },
                            plugins: { legend: { display: false } },
                            scales: { y: { min: 0, max: 100, position: 'right' } }
                        }
                    });
                    console.log('{{ symbol }} ADX ç¹ªè£½å®Œæˆ');
                    } catch (e) {
                        console.error('{{ symbol }} ç¹ªåœ–éŒ¯èª¤:', e);
                    }
                })
                .catch(err => {
                    clearTimeout(timeoutId);
                    console.error('{{ symbol }} è¼‰å…¥å¤±æ•—:', err);
                    document.getElementById('status-{{ symbol }}').innerText = 'âŒ ' + err.message;
                    document.getElementById('status-{{ symbol }}').className = 'text-sm px-3 py-1 rounded bg-red-600 text-white';
                });
        })();
        {% endfor %}

        // é é¢è¼‰å…¥
        document.addEventListener('DOMContentLoaded', function() {
            loadSymbols();
            
            // æ¯ 5 åˆ†é˜è‡ªå‹•åˆ·æ–°é é¢
            setInterval(function() {
                console.log('è‡ªå‹•åˆ·æ–°é é¢...');
                location.reload();
            }, 300000); // 5 åˆ†é˜ = 300000ms
        });
    </script>
</body>
</html>
